---
layout: post
title: "How To Deliver Larger Web Pages With An ESP8266"
date: 2017-10-25 21:00:26 +0200
category: [ESP8266, IoT, Arduino, Microcontroller ]
featured-img: esp8266
---
The ESP8266 is a low-cost Wi-Fi chip with full TCP/IP stack and microcontroller unit which makes it very attractive for small DIY IoT projects. When building a web server with the ESP8266, I stumbled over the problem of the limited message size of WiFiClients print() method (It is somewhere around 2922 bytes). Delivering more complex web pages, containing CSS and JavaScript, requires working around the limited memory of the device.
<center><figure><img src="/images/2017/configuration.png"><figcaption>A simple configuration page, 4430 bytes</figcaption></figure></center>

In my last project, I built a HTML template with inline CSS and JavaScript. The template contains HTML comments which are used as markers for a simple Ruby script.

{% highlight html %}
<!-- HEAD -->
...
<!-- SCRIPT -->  
...
<!-- STYLE -->      
...
{% endhighlight %}

The script cuts the HTML template at these marked lines and creates a C++ header file. 
{% highlight ruby %}
#!/usr/bin/ruby

require "yui/compressor"

TEMPLATING_RULES = [
  ["\"", "'"]
]

OUTPUT = File.open('../src/ConfigurationTemplate.h', 'w')

def process_html
    f = File.open 'configuration-template.html', 'r'
    compressor = YUI::CssCompressor.new
    
    OUTPUT.puts '//'
    OUTPUT.puts '// Do not edit this file, generated code.'
    OUTPUT.puts '//'
    OUTPUT.puts ''
    
    text = nil
    f.each_line do |line|
        if line.start_with? '<!--'
            if text
                OUTPUT.puts text + '";'
            end
            text = ''
            text += 'const char HTTP_' + line.split(' ')[1] + '[] PROGMEM = "'
        else
          TEMPLATING_RULES.each { |rule|
            line.gsub! rule[0], rule[1]
          }
          text += compressor.compress line
      end 
   end
   OUTPUT.close
end

process_html()
{% endhighlight %}
In the header file, the generated Strings, which can be very long, are stored using the PROGMEM() macro.
PROGMEM data is stored in flash (program) memory instead of the SRAM. On Arduino and ESP8266 a variable such as const char * will be placed in RAM, not flash memory. It is possible to place this variable into flash memory and load it when it is needed into RAM. 
{% highlight c++ %}
const char HTTP_HEAD[] PROGMEM = "<!DOCTYPE html><html><head lang='en'><title>My Title</title>";
{% endhighlight %}
In the web server, I had to concatenate the flash Strings to one HTTP response. For this case I used the FSPTR() macro. FSPTR takes a PROGMEM pointer and casts it to __FlashStringHelper to pass it to other functions. 
{% highlight c++ %}
server = new ESP8266WebServer(serverPort);
...
String page = FPSTR(HTTP_HEAD);
page += FPSTR(HTTP_SCRIPT);
page += FPSTR(HTTP_STYLE);
String body = FPSTR(HTTP_BODY);
... 
page += FPSTR(HTTP_FOOT);
... 
server->sendHeader("Content-Length", String(page.length()));
server->send(200, "text/html", page);
{% endhighlight %}
Without the ability to add runtime data the web page would be useless. I used simple String replacement to achieve this. In my template, I used the placeholder syntax {% raw %}{{property name}}{% endraw %} to mark which parts should be replaced. Here is an example:
{% highlight html %}
<p class="text">Firmware: <b>{% raw %}{{firmware}}{% endraw %}</b></p>
{% endhighlight %}
The web server replaces these placeholders when creating the HTTP response via String.replace() at runtime.
{% highlight c++ %}
String body = FPSTR(HTTP_BODY);
body.replace("{% raw %}{{firmware}}{% endraw %}", configuration.firmware);
page += body;
{% endhighlight %}
With this setup it is possible to deliver bigger web pages even with the limited RAM of an ESP8266. You can find the complete project on [GitHub][1]. 

Reference: [PROGMEM and FSPTR documentation][2] 

[1]: https://github.com/sglahn/esp8266-sensor-board-firmware
[2]: http://arduino-esp8266.readthedocs.io/en/latest/PROGMEM.html

<span itemprop="author" itemscope itemtype="https://schema.org/Person">
    <meta itemprop="name" content="Sebastian Glahn">
    <meta itemprop="url" content="http://blog.tldnr.org">
    <meta itemprop="sameAs" content="https://twitter.com/sglahn">
    <meta itemprop="sameAs" content="https://github.com/sglahn">
    <meta itemprop="sameAs" content="https://www.thingiverse.com/sglahn">
    <meta itemprop="sameAs" content="https://stackoverflow.com/users/1453205/sglahn">
</span>
